// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String                    @id
  role                     UserRole
  name                     String
  email                    String?                   @unique // Made optional for Telegram-first flow
  telegramUserId           String?                   @unique @map("telegram_user_id") // Telegram identity anchor
  pendingEmail             String?                   @map("pending_email") // Unverified email awaiting confirmation
  stripeConnectedAccountId String?                   @unique
  stripeCustomerId         String?                   @unique
  autoChargeEnabled        Boolean                   @default(false)
  onboardingStatus         String?
  onboardingData           Json?
  onboardingCompletedAt    DateTime?
  metadata                 Json?
  projects                 Project[]
  coupons                  Coupon[]
  contracts                Contract[]
  purchases                Purchase[]
  paymentMethods           PaymentMethod[]
  creatorTransfers         Transfer[]                @relation("CreatorTransfers")
  marketerTransfers        Transfer[]                @relation("MarketerTransfers")
  creatorPayments          CreatorPayment[]
  creatorAdjustments       CommissionAdjustment[]    @relation("CreatorAdjustments")
  marketerAdjustments      CommissionAdjustment[]    @relation("MarketerAdjustments")
  marketerMetricsSnapshots MarketerMetricsSnapshot[]
  events                   Event[]                   @relation("ActorEvents")
  notifications            Notification[]
  notificationPreference   NotificationPreference?
  testimonialsGiven        Testimonial[]             @relation("CreatorTestimonials")
  testimonialsReceived     Testimonial[]             @relation("MarketerTestimonials")
  rewardEarned             RewardEarned[]
  rewardCoupons            RewardCoupon[]
  feedbacks                Feedback[]
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  visibility               VisibilityMode            @default(PUBLIC)

  // RevClaw relations
  revclawInstallations     RevclawInstallation[]
  revclawIntentsOnBehalf   RevclawIntent[]           @relation("IntentOnBehalfOf")
  auditLogsOnBehalf        AuditLog[]                @relation("AuditOnBehalfOf")

  @@index([telegramUserId])
}

model Project {
  id                        String                    @id @default(cuid())
  userId                    String
  name                      String
  description               String?
  category                  String?                   @default("Other")
  refundWindowDays          Int                       @default(30)
  creatorStripeAccountId    String?                   @unique
  integrations              ProjectIntegration[]
  attributionAppKeys        AttributionAppKey[]
  attributionClicks         AttributionClick[]
  attributionInstallFingerprints AttributionInstallFingerprint[]
  attributionShortLinks     AttributionShortLink[]
  attributionDeferredTokens AttributionDeferredToken[]
  onboardingStatus          String?
  onboardingData            Json?
  onboardingCompletedAt     DateTime?
  currency                  String?
  platformCommissionPercent Decimal                   @default(0.2) @db.Decimal(5, 2)
  marketerCommissionPercent Decimal                   @default(0.2) @db.Decimal(5, 2)
  country                   String?
  website                   String?
  appStoreUrl               String?
  playStoreUrl              String?
  appScheme                 String?
  appTeamId                 String?                   // Apple Team ID (e.g., "ABC123XYZ")
  appBundleId               String?                   // iOS Bundle ID (e.g., "com.myapp.ios")
  androidPackageName        String?                   // Android package (e.g., "com.myapp.android")
  androidSha256Fingerprint  String?                   // Android signing cert fingerprint
  foundationDate            DateTime?
  about                     String?                   @db.Text
  features                  String[]                  @default([])
  logoUrl                   String?
  imageUrls                 String[]                  @default([])
  couponTemplates           CouponTemplate[]
  coupons                   Coupon[]
  purchases                 Purchase[]
  contracts                 Contract[]
  events                    Event[]
  commissionAdjustments     CommissionAdjustment[]
  metricsSnapshots          MetricsSnapshot[]
  marketerMetricsSnapshots  MarketerMetricsSnapshot[]
  testimonials              Testimonial[]
  rewards                   Reward[]
  rewardEarned              RewardEarned[]
  rewardCoupons             RewardCoupon[]
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime                  @updatedAt
  visibility                VisibilityMode            @default(PUBLIC)
  showMrr                   Boolean                   @default(true)
  showRevenue               Boolean                   @default(true)
  showStats                 Boolean                   @default(true)
  showAvgCommission         Boolean                   @default(true)
  autoApproveApplications   Boolean                   @default(false)
  autoApproveMatchTerms     Boolean                   @default(true)
  autoApproveVerifiedOnly   Boolean                   @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum IntegrationProvider {
  REVENUECAT
}

model ProjectIntegration {
  id             String              @id @default(cuid())
  projectId      String
  provider       IntegrationProvider
  externalId     String?
  apiKeyCipherText String
  apiKeyIv       String
  apiKeyTag      String
  webhookSecretCipherText String
  webhookSecretIv String
  webhookSecretTag String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, provider])
  @@index([projectId])
}

model AttributionAppKey {
  id        String   @id @default(cuid())
  projectId String
  keyHash   String   @unique
  keyCipherText String?
  keyIv     String?
  keyTag    String?
  name      String?
  createdAt DateTime @default(now())
  revokedAt DateTime?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model AttributionClick {
  id        String   @id @default(cuid())
  projectId String
  marketerId String
  deviceId  String
  url       String?
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, marketerId, deviceId])
  @@index([projectId])
  @@index([marketerId])
}

model AttributionInstallFingerprint {
  id          String   @id @default(cuid())
  projectId   String
  marketerId  String
  ipAddress   String
  deviceModel String
  osVersion   String
  platform    String?
  locale      String?
  userAgent   String?
  createdAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, ipAddress, deviceModel, osVersion])
  @@index([projectId])
  @@index([marketerId])
}

model AttributionShortLink {
  id        String   @id @default(cuid())
  projectId String
  marketerId String
  code      String   @unique
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, marketerId])
  @@index([projectId])
  @@index([marketerId])
}

model AttributionDeferredToken {
  id         String    @id @default(cuid())
  token      String    @unique
  projectId  String
  marketerId String
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([projectId])
  @@index([createdAt])
}

model Contract {
  id                String         @id @default(cuid())
  projectId         String
  userId            String
  commissionPercent Decimal        @db.Decimal(5, 2)
  message           String?        @db.Text
  refundWindowDays  Int?
  status            ContractStatus @default(PENDING)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  testimonial Testimonial?

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Coupon {
  id                    String         @id @default(cuid())
  projectId             String
  templateId            String
  marketerId            String
  code                  String         @unique
  stripeCouponId        String
  stripePromotionCodeId String         @unique
  percentOff            Int
  commissionPercent     Decimal        @db.Decimal(5, 2)
  status                CouponStatus   @default(ACTIVE)
  claimedAt             DateTime       @default(now())
  project               Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  template              CouponTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  marketer              User           @relation(fields: [marketerId], references: [id], onDelete: Cascade)
  purchases             Purchase[]

  @@unique([templateId, marketerId])
  @@index([projectId])
  @@index([templateId])
  @@index([marketerId])
  @@index([stripeCouponId])
}

model CouponTemplate {
  id                 String       @id @default(cuid())
  projectId          String
  name               String
  description        String?
  percentOff         Int
  durationType       CouponDuration @default(ONCE)
  durationInMonths   Int?
  startAt            DateTime?
  endAt              DateTime?
  maxRedemptions     Int?
  productIds         Json?
  allowedMarketerIds Json?
  stripeCouponId     String       @unique
  status             CouponStatus @default(ACTIVE)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  coupons Coupon[]

  @@index([projectId])
  @@index([status])
}

model Reward {
  id                String              @id @default(cuid())
  projectId         String
  name              String
  description       String?
  milestoneType     RewardMilestoneType @default(NET_REVENUE)
  milestoneValue    Int
  rewardType        RewardType
  rewardLabel       String?
  rewardPercentOff  Int?
  rewardDurationMonths Int?
  rewardAmount      Int?
  rewardCurrency    String?
  allowedMarketerIds Json?
  fulfillmentType   RewardFulfillment   @default(AUTO_COUPON)
  earnLimit         RewardEarnLimit     @default(ONCE_PER_MARKETER)
  availabilityType  RewardAvailability  @default(UNLIMITED)
  availabilityLimit Int?
  visibility        RewardVisibility    @default(PUBLIC)
  startsAt          DateTime            @default(now())
  status            RewardStatus        @default(DRAFT)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  earned  RewardEarned[]

  @@index([projectId])
  @@index([status])
}

model RewardEarned {
  id         String             @id @default(cuid())
  rewardId   String
  projectId  String
  marketerId String
  sequence   Int                @default(1)
  status     RewardEarnedStatus @default(UNLOCKED)
  earnedAt   DateTime           @default(now())
  unlockedAt DateTime?
  claimedAt  DateTime?
  rewardAmount    Int?
  rewardCurrency  String?
  rewardTransferId String?
  paidAt          DateTime?

  reward   Reward  @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  marketer User    @relation(fields: [marketerId], references: [id], onDelete: Cascade)
  rewardCoupon RewardCoupon?

  @@unique([rewardId, marketerId, sequence])
  @@index([projectId])
  @@index([marketerId])
  @@index([projectId, marketerId])
  @@index([status])
}

model RewardCoupon {
  id                    String   @id @default(cuid())
  rewardEarnedId         String  @unique
  projectId              String
  marketerId             String
  stripeCouponId         String?
  stripePromotionCodeId  String?
  code                   String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  rewardEarned RewardEarned @relation(fields: [rewardEarnedId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  marketer     User         @relation(fields: [marketerId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([marketerId])
  @@index([stripeCouponId])
  @@index([stripePromotionCodeId])
}

model Purchase {
  id                       String           @id @default(cuid())
  projectId                String
  couponId                 String?
  marketerId               String?
  stripeEventId            String?          @unique
  stripeChargeId           String?
  stripeInvoiceId          String?
  stripePaymentIntentId    String?
  revenueCatEventId        String?          @unique
  revenueCatTransactionId  String?          @unique
  amount                   Int
  currency                 String
  customerEmail            String?
  customerExternalId       String?
  commissionAmount         Int
  commissionAmountOriginal Int?
  refundedAmount           Int              @default(0)
  refundedAt               DateTime?
  disputeId                String?
  disputeStatus            String?
  chargebackAt             DateTime?
  refundWindowDays         Int?
  refundEligibleAt         DateTime?
  transferId               String?
  transferRecordId         String?
  creatorPaymentId         String?
  commissionStatus         CommissionStatus @default(PENDING_CREATOR_PAYMENT)
  status                   PayoutStatus     @default(PENDING)
  createdAt                DateTime         @default(now())

  project               Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  coupon                Coupon?                @relation(fields: [couponId], references: [id], onDelete: SetNull)
  marketer              User?                  @relation(fields: [marketerId], references: [id], onDelete: SetNull)
  transferRecord        Transfer?              @relation(fields: [transferRecordId], references: [id], onDelete: SetNull)
  creatorPayment        CreatorPayment?        @relation(fields: [creatorPaymentId], references: [id], onDelete: SetNull)
  commissionAdjustments CommissionAdjustment[]

  @@index([projectId])
  @@index([couponId])
  @@index([marketerId])
  @@index([transferRecordId])
  @@index([creatorPaymentId])
}

model Event {
  id          String    @id @default(cuid())
  type        EventType
  actorId     String?
  projectId   String?
  subjectType String?
  subjectId   String?
  data        Json?
  createdAt   DateTime  @default(now())

  actor         User?          @relation("ActorEvents", fields: [actorId], references: [id], onDelete: SetNull)
  project       Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  notifications Notification[]

  @@index([type])
  @@index([actorId])
  @@index([projectId])
  @@index([subjectType, subjectId])
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  eventId   String?
  type      NotificationType
  title     String
  message   String?
  data      Json?
  status    NotificationStatus @default(UNREAD)
  readAt    DateTime?
  createdAt DateTime           @default(now())

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event? @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventId])
  @@index([status])
}

model NotificationPreference {
  id             String   @id @default(cuid())
  userId         String   @unique
  emailEnabled   Boolean  @default(false)
  webhookEnabled Boolean  @default(false)
  webhookUrl     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum CouponStatus {
  ACTIVE
  REVOKED
}

enum CouponDuration {
  ONCE
  REPEATING
}

enum ContractStatus {
  PENDING
  APPROVED
  REJECTED
  PAUSED
}

enum RewardStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum RewardMilestoneType {
  NET_REVENUE
  COMPLETED_SALES
  ACTIVE_CUSTOMERS
}

enum RewardType {
  DISCOUNT_COUPON
  FREE_SUBSCRIPTION
  PLAN_UPGRADE
  ACCESS_PERK
  MONEY
}

enum RewardFulfillment {
  AUTO_COUPON
  MANUAL
}

enum RewardEarnLimit {
  ONCE_PER_MARKETER
  MULTIPLE
}

enum RewardAvailability {
  UNLIMITED
  FIRST_N
}

enum RewardVisibility {
  PUBLIC
  PRIVATE
}

enum RewardEarnedStatus {
  PENDING_REFUND
  UNLOCKED
  CLAIMED
  PAID
}

enum EventType {
  USER_SIGNED_UP
  USER_LOGGED_IN
  PROJECT_CREATED
  PROJECT_UPDATED
  REWARD_CREATED
  REWARD_UPDATED
  REWARD_STATUS_CHANGED
  REWARD_EARNED
  REWARD_CLAIMED
  REWARD_PAID
  COUPON_TEMPLATE_CREATED
  COUPON_TEMPLATE_UPDATED
  COUPON_CLAIMED
  PURCHASE_CREATED
  PURCHASE_REFUNDED
  PURCHASE_CHARGEBACK
  PURCHASE_CHARGEBACK_RESOLVED
  CREATOR_PAYMENT_CREATED
  CREATOR_PAYMENT_COMPLETED
  TRANSFER_INITIATED
  TRANSFER_COMPLETED
  TRANSFER_FAILED
  CONTRACT_CREATED
  CONTRACT_APPROVED
  CONTRACT_REJECTED
  CONTRACT_PAUSED
  CONTRACT_RESUMED
  NOTIFICATION_SENT
}

enum NotificationType {
  SALE
  COMMISSION_DUE
  COMMISSION_READY
  REFUND
  CHARGEBACK
  PAYOUT_SENT
  PAYOUT_FAILED
  CONTRACT_APPROVED
  CONTRACT_REJECTED
  PROJECT_UPDATE
  SYSTEM
}

enum UserRole {
  founder
  marketer
}

enum PayoutStatus {
  PENDING
  PAID
  FAILED
}

enum CommissionStatus {
  PENDING_CREATOR_PAYMENT
  AWAITING_REFUND_WINDOW
  READY_FOR_PAYOUT
  PAID
  REFUNDED
  CHARGEBACK
}

enum AdjustmentReason {
  REFUND
  CHARGEBACK
  CHARGEBACK_REVERSAL
}

enum AdjustmentStatus {
  PENDING
  APPLIED
  REVERSED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model CreatorPayment {
  id                      String        @id @default(cuid())
  creatorId               String
  amountTotal             Int
  marketerTotal           Int
  platformFeeTotal        Int
  currency                String?
  status                  PaymentStatus @default(PENDING)
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  creator   User       @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  purchases Purchase[]

  @@index([creatorId])
  @@index([stripeCheckoutSessionId])
}

model Transfer {
  id               String       @id @default(cuid())
  creatorId        String
  marketerId       String
  amount           Int
  currency         String
  status           PayoutStatus @default(PENDING)
  stripeTransferId String?
  failureReason    String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  creator   User       @relation("CreatorTransfers", fields: [creatorId], references: [id], onDelete: Cascade)
  marketer  User       @relation("MarketerTransfers", fields: [marketerId], references: [id], onDelete: Cascade)
  purchases Purchase[]

  @@index([creatorId])
  @@index([marketerId])
  @@index([stripeTransferId])
}

model CommissionAdjustment {
  id         String           @id @default(cuid())
  creatorId  String
  marketerId String
  projectId  String
  purchaseId String?
  amount     Int
  currency   String
  reason     AdjustmentReason
  status     AdjustmentStatus @default(PENDING)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  creator  User      @relation("CreatorAdjustments", fields: [creatorId], references: [id], onDelete: Cascade)
  marketer User      @relation("MarketerAdjustments", fields: [marketerId], references: [id], onDelete: Cascade)
  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  purchase Purchase? @relation(fields: [purchaseId], references: [id], onDelete: SetNull)

  @@index([creatorId])
  @@index([marketerId])
  @@index([projectId])
  @@index([purchaseId])
  @@index([status])
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  userId                String
  stripePaymentMethodId String   @unique
  type                  String
  brand                 String?
  last4                 String?
  expMonth              Int?
  expYear               Int?
  bankName              String?
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MetricsSnapshot {
  id                         String   @id @default(dbgenerated("gen_random_uuid()"))
  projectId                  String
  date                       DateTime
  totalRevenue               Int
  affiliateRevenue           Int
  affiliateShareOwed         Int
  platformFee                Int
  mrr                        Int
  purchasesCount             Int
  affiliatePurchasesCount    Int
  directPurchasesCount       Int
  uniqueCustomers            Int
  affiliateCustomers         Int      @default(0)
  totalRevenueDay            Int      @default(0)
  affiliateRevenueDay        Int      @default(0)
  affiliateShareOwedDay      Int      @default(0)
  platformFeeDay             Int      @default(0)
  mrrDay                     Int      @default(0)
  purchasesCountDay          Int      @default(0)
  affiliatePurchasesCountDay Int      @default(0)
  directPurchasesCountDay    Int      @default(0)
  uniqueCustomersDay         Int      @default(0)
  affiliateCustomersDay      Int      @default(0)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, date])
  @@index([projectId])
  @@index([date])
}

model MarketerMetricsSnapshot {
  id                  String   @id @default(dbgenerated("gen_random_uuid()"))
  projectId           String
  marketerId          String
  date                DateTime
  affiliateRevenueDay Int      @default(0)
  commissionOwedDay   Int      @default(0)
  purchasesCountDay   Int      @default(0)
  customersCountDay   Int      @default(0)
  clicksCountDay      Int      @default(0)
  installsCountDay    Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  marketer User    @relation(fields: [marketerId], references: [id], onDelete: Cascade)

  @@unique([projectId, marketerId, date])
  @@index([projectId])
  @@index([marketerId])
  @@index([date])
}

model Testimonial {
  id         String   @id @default(cuid())
  contractId String   @unique
  creatorId  String
  marketerId String
  projectId  String
  rating     Int // 1-5 stars
  text       String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  creator  User     @relation("CreatorTestimonials", fields: [creatorId], references: [id], onDelete: Cascade)
  marketer User     @relation("MarketerTestimonials", fields: [marketerId], references: [id], onDelete: Cascade)
  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([creatorId])
  @@index([marketerId])
  @@index([projectId])
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  message   String   @db.Text
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum VisibilityMode {
  PUBLIC
  GHOST
  PRIVATE
}

model Waitlist {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  source    String?  @default("landing")
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

// =============================================================================
// RevClaw Models - Bot Delegation System
// =============================================================================

/// Bot/agent identity + manifest snapshot
model RevclawAgent {
  id                  String               @id @default(cuid())
  name                String               // Human-readable agent name
  manifestUrl         String?              @map("manifest_url") // Original manifest URL (validated: no private IPs)
  manifestSnapshot    String?              @db.Text @map("manifest_snapshot") // Immutable snapshot at registration
  manifestSnapshotHash String?             @map("manifest_snapshot_hash") // SHA-256 of snapshot for integrity
  agentSecretHash     String               @map("agent_secret_hash") // Hashed agent_secret (bcrypt/argon2)
  identityProofUrl    String?              @map("identity_proof_url") // Optional: URL for Moltbook-style verification
  metadata            Json?                // Additional agent metadata
  status              RevclawAgentStatus   @default(ACTIVE)
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")

  // Relations
  registrations       RevclawRegistration[]
  installations       RevclawInstallation[]
  intents             RevclawIntent[]
  auditLogs           AuditLog[]

  @@index([status])
  @@map("revclaw_agents")
}

/// Pending claim/approval (expires)
model RevclawRegistration {
  id              String                     @id @default(cuid())
  agentId         String                     @map("agent_id")
  claimId         String                     @unique @map("claim_id") // Single-use, short-lived, unguessable
  requestedScopes String[]                   @map("requested_scopes") // Scopes the bot is requesting
  status          RevclawRegistrationStatus  @default(PENDING)
  expiresAt       DateTime                   @map("expires_at") // Claim expiration
  claimedAt       DateTime?                  @map("claimed_at")
  claimedByUserId String?                    @map("claimed_by_user_id") // Telegram-authenticated user who claimed
  metadata        Json?                      // Additional registration context
  createdAt       DateTime                   @default(now()) @map("created_at")
  updatedAt       DateTime                   @updatedAt @map("updated_at")

  // Relations
  agent           RevclawAgent               @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([claimId])
  @@index([status])
  @@index([expiresAt])
  @@map("revclaw_registrations")
}

/// Agent â†” User binding with granted scopes + policy
model RevclawInstallation {
  id              String                     @id @default(cuid())
  agentId         String                     @map("agent_id")
  userId          String                     @map("user_id")
  grantedScopes   String[]                   @map("granted_scopes") // Scopes actually granted
  
  // Policy settings (human-configurable guardrails)
  requireApprovalForPublish Boolean          @default(true) @map("require_approval_for_publish")
  requireApprovalForApply   Boolean          @default(true) @map("require_approval_for_apply")
  dailyApplyLimit           Int?             @map("daily_apply_limit") // Optional rate limit
  allowedCategories         String[]         @map("allowed_categories") // Optional category restrictions
  
  // Token management (hashed/encrypted at rest)
  refreshTokenHash          String?          @map("refresh_token_hash") // Rotating refresh token (hashed)
  refreshTokenVersion       Int              @default(1) @map("refresh_token_version") // For rotation invalidation
  lastTokenIssuedAt         DateTime?        @map("last_token_issued_at")
  
  status          RevclawInstallationStatus  @default(ACTIVE)
  revokedAt       DateTime?                  @map("revoked_at")
  revokeReason    String?                    @map("revoke_reason")
  metadata        Json?                      // Additional installation context
  createdAt       DateTime                   @default(now()) @map("created_at")
  updatedAt       DateTime                   @updatedAt @map("updated_at")

  // Relations
  agent           RevclawAgent               @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user            User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  intents         RevclawIntent[]
  exchangeCodes   RevclawExchangeCode[]
  accessTokens    RevclawAccessToken[]

  @@unique([agentId, userId]) // One installation per agent-user pair
  @@index([agentId])
  @@index([userId])
  @@index([status])
  @@map("revclaw_installations")
}

/// Exchange codes for token issuance (single-use, short-lived)
model RevclawExchangeCode {
  id              String                     @id @default(cuid())
  installationId  String                     @map("installation_id")
  codeHash        String                     @unique @map("code_hash") // Hashed exchange code
  scopesSnapshot  String[]                   @map("scopes_snapshot") // Scopes at generation time
  status          RevclawExchangeCodeStatus  @default(PENDING)
  expiresAt       DateTime                   @map("expires_at") // Short-lived (5 minutes)
  usedAt          DateTime?                  @map("used_at")
  createdAt       DateTime                   @default(now()) @map("created_at")

  // Relations
  installation    RevclawInstallation        @relation(fields: [installationId], references: [id], onDelete: Cascade)

  @@index([installationId])
  @@index([codeHash])
  @@index([status])
  @@index([expiresAt])
  @@map("revclaw_exchange_codes")
}

/// Access and refresh tokens (hashed at rest)
model RevclawAccessToken {
  id              String                     @id @default(cuid())
  installationId  String                     @map("installation_id")
  tokenHash       String                     @unique @map("token_hash") // Hashed token
  tokenType       RevclawTokenType           @map("token_type") // ACCESS or REFRESH
  scopesSnapshot  String[]                   @map("scopes_snapshot") // Scopes at generation time
  expiresAt       DateTime                   @map("expires_at")
  revokedAt       DateTime?                  @map("revoked_at")
  lastUsedAt      DateTime?                  @map("last_used_at")
  
  // For refresh tokens: track parent to detect reuse
  parentTokenId   String?                    @map("parent_token_id") // Previous refresh token in chain
  refreshedAt     DateTime?                  @map("refreshed_at") // When this refresh token was used
  
  createdAt       DateTime                   @default(now()) @map("created_at")

  // Relations
  installation    RevclawInstallation        @relation(fields: [installationId], references: [id], onDelete: Cascade)

  @@index([installationId])
  @@index([tokenHash])
  @@index([tokenType])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("revclaw_access_tokens")
}

/// Proposed action requiring approval (immutable payload)
model RevclawIntent {
  id                  String              @id @default(cuid())
  installationId      String              @map("installation_id")
  agentId             String              @map("agent_id")
  onBehalfOfUserId    String              @map("on_behalf_of_user_id")
  
  kind                RevclawIntentKind   // publish, apply, etc.
  payloadJson         Json                @map("payload_json") // Immutable action payload
  payloadHash         String              @map("payload_hash") // SHA-256 for integrity verification
  idempotencyKey      String              @map("idempotency_key") // Client-provided for deduplication
  
  status              RevclawIntentStatus @default(PENDING_APPROVAL)
  approvedAt          DateTime?           @map("approved_at")
  approvedPayloadHash String?             @map("approved_payload_hash") // Hash at approval time (must match payloadHash)
  deniedAt            DateTime?           @map("denied_at")
  denyReason          String?             @map("deny_reason")
  executedAt          DateTime?           @map("executed_at")
  executionResult     Json?               @map("execution_result") // Result of execution (success/error details)
  expiresAt           DateTime            @map("expires_at") // Intent expiration
  
  metadata            Json?               // Additional intent context
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  installation        RevclawInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  agent               RevclawAgent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  onBehalfOfUser      User                @relation("IntentOnBehalfOf", fields: [onBehalfOfUserId], references: [id], onDelete: Cascade)

  @@unique([idempotencyKey, installationId]) // Idempotency per installation
  @@index([installationId])
  @@index([agentId])
  @@index([onBehalfOfUserId])
  @@index([status])
  @@index([kind])
  @@index([expiresAt])
  @@map("revclaw_intents")
}

/// Tamper-evident append-only audit log with hash chaining
model AuditLog {
  id                  String              @id @default(cuid())
  sequence            BigInt              @unique @default(autoincrement()) // Monotonic sequence for ordering
  
  // Attribution (who performed the action)
  performedByAgentId  String?             @map("performed_by_agent_id")
  onBehalfOfUserId    String?             @map("on_behalf_of_user_id")
  
  // Action details
  action              String              // Action type (e.g., "project.publish", "application.submit")
  resourceType        String              @map("resource_type") // Entity type (e.g., "Project", "Contract")
  resourceId          String              @map("resource_id") // Entity ID
  
  // Request context
  requestId           String?             @map("request_id") // Correlation ID
  idempotencyKey      String?             @map("idempotency_key") // If action used idempotency
  ipAddress           String?             @map("ip_address") // Requester IP (for security audits)
  userAgent           String?             @map("user_agent") // Requester user-agent
  
  // Payload (MUST NOT include secrets)
  payload             Json?               // Action-specific data (redacted of secrets)
  
  // Hash chaining for tamper evidence
  previousHash        String?             @map("previous_hash") // Hash of previous entry (null for first)
  entryHash           String              @map("entry_hash") // SHA-256(sequence + previous_hash + action + resource + timestamp + payload)
  
  createdAt           DateTime            @default(now()) @map("created_at")

  // Relations (optional, for easier querying)
  performedByAgent    RevclawAgent?       @relation(fields: [performedByAgentId], references: [id], onDelete: SetNull)
  onBehalfOfUser      User?               @relation("AuditOnBehalfOf", fields: [onBehalfOfUserId], references: [id], onDelete: SetNull)

  @@index([performedByAgentId])
  @@index([onBehalfOfUserId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@index([sequence])
  @@map("audit_logs")
}

// =============================================================================
// RevClaw Enums
// =============================================================================

enum RevclawAgentStatus {
  ACTIVE
  SUSPENDED
  REVOKED
}

enum RevclawRegistrationStatus {
  PENDING
  CLAIMED
  EXPIRED
  REVOKED
}

enum RevclawInstallationStatus {
  ACTIVE
  SUSPENDED
  REVOKED
}

enum RevclawIntentKind {
  PROJECT_PUBLISH
  APPLICATION_SUBMIT
}

enum RevclawIntentStatus {
  PENDING_APPROVAL
  APPROVED
  DENIED
  EXECUTED
  EXPIRED
}

enum RevclawExchangeCodeStatus {
  PENDING
  USED
  EXPIRED
  REVOKED
}

enum RevclawTokenType {
  ACCESS
  REFRESH
}
